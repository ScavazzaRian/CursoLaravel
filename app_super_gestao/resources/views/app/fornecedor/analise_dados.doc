/*
    Aqui e um exemplo de diversas consultas que montei durante meu periodo na Napp.
    Cada uma sendo diferente de outro e atendendo a necessidade dos clientes.
*/
SELECT
    P.ID_PRODUTO,
    P.DESCRICAO,
    B.CODIGO_BARRAS AS EAN,
    E.QUANTIDADE AS QTDE,
    V.PRECO_VENDA AS BRUTO,
    CASE
        WHEN FN_CALCULA_PRECO_CUSTOMIZADO(
            P.ID_PRODUTO,
            V.PRECO_VENDA,
            E.ID_FILIAL,
            P.ID_LABORATORIO,
            P.ID_GRUPO,
            P.ID_SUBGRUPO,
            P.ID_CATEGORIA
        ) > 0 THEN FN_CALCULA_PRECO_CUSTOMIZADO(
            P.ID_PRODUTO,
            V.PRECO_VENDA,
            E.ID_FILIAL,
            P.ID_LABORATORIO,
            P.ID_GRUPO,
            P.ID_SUBGRUPO,
            P.ID_CATEGORIA
        )
        WHEN PP.VALOR_PROMOCAO > 0 THEN PP.VALOR_PROMOCAO
        ELSE V.PRECO_VENDA 
    END AS LIQUIDO,
    CASE
        WHEN P.SITUACAO = 'ATIVO' THEN 'Ativo'
        ELSE 'Inativo'
    END AS STATUS
FROM
    TB_PRODUTO P
    LEFT JOIN TB_CODIGO_BARRAS B ON B.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN TB_PRECO_VENDA V ON V.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN TB_ESTOQUE E ON E.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN TB_PROMOCAO_ITEM PP ON PP.ID_PRODUTO = P.ID_PRODUTO
        AND PP.ID_FILIAL = E.ID_FILIAL
        AND PP.DATA_FIM >= CURRENT_DATE
WHERE
    E.ID_FILIAL = '';

---------------------------------------------------

SELECT
    P.ID_PRODUTO,
    P.EAN,
    CONCAT(P.DESCRICAO, ' ', P.APRESENTACAO) AS DESCRICAO,
    E.QUANTIDADE_ESTOQUE AS QTDE,
    E.PRECO_CONSUMIDOR AS BRUTO,
    ROUND(
        CASE
            WHEN SUBSTRING(E.REGRA_PROMOCAO, 1, 3) = '001' THEN COALESCE(
                E.PRECO_CONSUMIDOR - (
                    E.PRECO_CONSUMIDOR * CAST(
                        CONCAT(
                            SUBSTRING(E.REGRA_PROMOCAO, 6, 1),
                            '.',
                            SUBSTRING(E.REGRA_PROMOCAO, 7, 3)
                        ) AS DECIMAL(10, 4)
                    )
                ),
                E.PRECO_CONSUMIDOR
            )
            ELSE E.PRECO_CONSUMIDOR
        END,
        2
    ) AS LIQUIDO,
    'Ativo' AS STATUS
FROM
    TB_PRODUTO P
    LEFT JOIN TB_DETALHE_PRODUTO E ON E.ID_PRODUTO = P.ID_PRODUTO
WHERE
    E.TIPO_REGISTRO = '2';

---------------------------------------------------

SELECT
    P.ID_PRODUTO,
    P.NOME_PRODUTO AS DESCRICAO,
    B.CODIGO_BARRAS AS EAN,
    E.QTD_ESTOQUE AS QTDE,
    COALESCE(P.VALOR_VENDA_ECOMMERCE, P.VALOR_VENDA) AS LIQUIDO,
    CASE
        WHEN P.FLAG_ATIVO = 'A' THEN 'Ativo'
        ELSE 'Inativo'
    END AS STATUS
FROM
    TB_PRODUTO P
    LEFT JOIN TB_CODIGO_BARRAS B ON B.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN TB_ESTOQUE E ON E.ID_PRODUTO = P.ID_PRODUTO
WHERE
    E.ID_FILIAL = '';

---------------------------------------------------

WITH CTE_PRECO_PROMOCIONAL AS (
    SELECT
        PP.ID_PRODUTO,
        PP.PERCENTUAL_DESCONTO,
        PP.DESCONTO_INDIVIDUAL
    FROM
        TB_PROMOCAO_ITEM PP
        INNER JOIN TB_PROMOCAO_CABECALHO PC ON PC.ID = PP.ID_PROMOCAO
    WHERE
        PC.DATA_FIM >= CURRENT_DATE
        AND PP.DATA_EXCLUSAO IS NULL
        AND PC.DATA_EXCLUSAO IS NULL
)
SELECT
    P.ID_PRODUTO,
    P.EAN,
    P.DESCRICAO,
    E.QUANTIDADE_ATUAL AS QTDE,
    P.PRECO_VENDA AS BRUTO,
    CASE
        WHEN PP.PERCENTUAL_DESCONTO > 0 THEN ROUND(P.PRECO_VENDA * (1 - PP.PERCENTUAL_DESCONTO / 100), 2)
        WHEN PP.DESCONTO_INDIVIDUAL > 0 THEN ROUND(P.PRECO_VENDA * (1 - PP.DESCONTO_INDIVIDUAL / 100), 2)
        ELSE ROUND(P.PRECO_VENDA - (P.PRECO_VENDA * COALESCE(P.DESCONTO_MAXIMO, 0) / 100), 2)
    END AS LIQUIDO,
    P.STATUS
FROM
    TB_PRODUTO P
    LEFT JOIN TB_ESTOQUE E ON E.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN CTE_PRECO_PROMOCIONAL PP ON PP.ID_PRODUTO = P.ID_PRODUTO
WHERE
    E.ID_EMPRESA = '';

---------------------------------------------------

SELECT
    ID_PRODUTO,
    DESCRICAO,
    EAN,
    SALDO_ESTOQUE AS QTDE,
    PRECO_TABELA AS BRUTO,
    CASE
        WHEN DATA_VALIDADE_PROMO >= CURRENT_DATE AND VALOR_PROMO > 0.01 THEN VALOR_PROMO
        ELSE PRECO_TABELA
    END AS LIQUIDO,
    CASE
        WHEN STATUS = 'A' THEN 'Ativo'
        ELSE 'Inativo'
    END AS STATUS
FROM
    TB_PRODUTO;

---------------------------------------------------

SELECT
    A.ID_PRODUTO,
    A.DESCRICAO,
    COALESCE(A.EAN13, '') AS EAN,
    COALESCE(A.ESTOQUE_FILIAL, 0) AS QTDE,
    COALESCE(L.PRECO_PROMOCIONAL, A.PRECO_VENDA) AS LIQUIDO,
    'Ativo' AS STATUS
FROM
    TB_PRODUTO A
    LEFT JOIN TB_LISTA_PRECOS L ON L.ID_PRODUTO = A.ID_PRODUTO
    AND L.DATA_FINAL >= CURRENT_DATE
UNION ALL
SELECT
    A.ID_PRODUTO,
    A.DESCRICAO,
    A.EAN_SECUNDARIO AS EAN,
    COALESCE(A.ESTOQUE_FILIAL, 0) AS QTDE,
    COALESCE(L.PRECO_PROMOCIONAL, A.ID_PRODUTO) AS LIQUIDO,
    'Ativo' AS STATUS
FROM
    TB_PRODUTO A
    LEFT JOIN TB_LISTA_PRECOS L ON L.ID_PRODUTO = A.ID_PRODUTO
    AND L.DATA_FINAL >= CURRENT_DATE
WHERE
    A.EAN_SECUNDARIO IS NOT NULL;

---------------------------------------------------

SELECT
    P.ID_PRODUTO,
    P.NOME_PRODUTO AS DESCRICAO,
    P.EAN,
    E.QUANTIDADE AS QTDE,
    CASE
        WHEN PR.VALOR_PROMOCAO > 0 THEN PR.VALOR_PROMOCAO
        WHEN PR.PERCENTUAL_DESCONTO > 0 THEN ROUND(P.PRECO_VENDA - (P.PRECO_VENDA * PR.PERCENTUAL_DESCONTO / 100), 2)
        WHEN E.PRECO_ESPECIFICO > 0 THEN E.PRECO_ESPECIFICO
        ELSE P.PRECO_VENDA
    END AS LIQUIDO,
    CASE
        WHEN P.SITUACAO = 'A' THEN 'Ativo'
        ELSE 'Inativo'
    END AS STATUS
FROM
    TB_PRODUTO P
    LEFT JOIN TB_ESTOQUE E ON E.ID_PRODUTO = P.ID_PRODUTO
    LEFT JOIN (
        SELECT
            P.ID_PRODUTO,
            P.ID_LOJA,
            PD.PERCENTUAL AS PERCENTUAL_DESCONTO,
            PD.VALOR AS VALOR_PROMOCAO
        FROM
            TB_PROMOCAO P
            INNER JOIN TB_PROMOCAO_DETALHE PD ON PD.ID_PROMOCAO = P.ID_PROMOCAO
        WHERE
            P.DATA_FIM >= CURRENT_DATE
            AND PD.ATIVO = 'S'
    ) PR ON PR.ID_PRODUTO = P.ID_PRODUTO
    AND PR.ID_LOJA = E.ID_LOJA;

---------------------------------------------------

SELECT
    ID_PRODUTO,
    DESCRICAO,
    CODIGO_NCM AS NCM,
    QUANTIDADE_ESTOQUE AS QTDE,
    PRECO_CONSUMIDOR AS BRUTO,
    CASE
        WHEN DATA_INICIO_PROMO <= CURRENT_DATE AND DATA_FIM_PROMO >= CURRENT_DATE THEN ROUND(PRECO_CONSUMIDOR - (PRECO_CONSUMIDOR * PERCENTUAL_DESCONTO / 100), 2)
        WHEN PRECO_WEB > 0 THEN PRECO_WEB
        ELSE PRECO_CONSUMIDOR
    END AS LIQUIDO,
    'Ativo' AS STATUS
FROM
    TB_PRODUTO;